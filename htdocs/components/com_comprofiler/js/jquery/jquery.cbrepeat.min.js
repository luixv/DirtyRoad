(function(w){var n=[];var t={init:function(t){return this.each(function(){var a=this;var r=w(a).data("cbrepeat");if(r){return}r={};r.options=typeof t!="undefined"?t:{};r.defaults=w.fn.cbrepeat.defaults;r.settings=w.extend(true,{},r.defaults,r.options);r.element=w(a);if(r.settings.useData){w.each(r.defaults,function(e,t){if(e!="init"&&e!="useData"){var i=r.element.data("cbrepeat"+e.charAt(0).toUpperCase()+e.slice(1));if(typeof i!="undefined"){r.settings[e]=i}else{i=r.element.data("cbrepeat"+e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());if(typeof i!="undefined"){r.settings[e]=i}}}})}if(!r.settings.min){r.settings.min=1}r.element.triggerHandler("cbrepeat.init.before",[r]);if(!r.settings.init){return}if(r.settings.sortable){var e=r.element.find(".cbRepeatRow").filter(function(){return w(this).closest(".cbRepeat").is(r.element)}).first();r.element.sortable({placeholder:e.attr("class")+" cbRepeatRowPlaceholder",forcePlaceholderSize:true,cursor:"move",items:".cbRepeatRow",containment:"parent",animated:true,stop:function(e,t){var i=[];r.element.find(".cbRepeatRow").filter(function(){return w(this).closest(".cbRepeat").is(r.element)}).find("input:checked").each(function(){i.push(w(this))});p.call(a,r);w.each(i,function(e,t){t.prop("checked",true)});r.element.triggerHandler("cbrepeat.move",[r,e,t])},tolerance:"pointer",handle:".cbRepeatRowMove",opacity:.5})}r.addHandler=function(e){e.preventDefault();e.stopPropagation();var t=r.element.find(".cbRepeatRowAddCount").filter(function(){return w(this).closest(".cbRepeat").is(r.element)});var i=1;if(t.length&&t.val()>0){i=t.val()}if(r.settings.limit&&i>r.settings.limit){i=r.settings.limit;if(t.length){t.val(i)}}s.call(a,i)};if(r.settings.add){r.element.find(".cbRepeatRowAdd").filter(function(){return w(this).closest(".cbRepeat").is(r.element)}).on("click.cbrepeat",r.addHandler)}r.removeHandler=function(e){e.preventDefault();e.stopPropagation();var t=w(this).closest(".cbRepeatRow");i.call(a,t)};if(r.settings.remove){r.element.find(".cbRepeatRowRemove").filter(function(){return w(this).closest(".cbRepeat").is(r.element)}).on("click.cbrepeat",r.removeHandler)}p.call(a,r);r.element.on("remove.cbrepeat destroy.cbrepeat",function(){r.element.cbrepeat("destroy")});r.element.on("rebind.cbrepeat",function(){r.element.cbrepeat("rebind")});r.element.on("modified.cbrepeat",function(e,t,i,a){if(i!=a){r.element.cbrepeat("rebind")}});r.element.on("cloned.cbrepeat",function(){w(this).off(".cbrepeat");w(this).removeData("cbrepeat");w(this).removeData("uiSortable");w(this).removeData("ui-sortable");var e=w(this).find(".cbRepeatRow").first().parent();w(this).find(".cbRepeatRowAdd").filter(function(){return w(this).closest(".cbRepeat").is(e)}).off("click.cbrepeat",r.addHandler);w(this).find(".cbRepeatRowRemove").filter(function(){return w(this).closest(".cbRepeat").is(e)}).off("click.cbrepeat",r.removeHandler);w(this).cbrepeat(r.options)});r.element.triggerHandler("cbrepeat.init.after",[r]);r.element.data("cbrepeat",r);n.push(r)})},add:function(e){if(!e){e=1}s.call(this,e);return this},remove:function(e){i.call(this,e);return this},update:function(){var e=w(this).data("cbrepeat");if(!e){return this}p.call(this,e);return this},reset:function(){var e=w(this).data("cbrepeat");if(!e){return this}var t=e.element.find(".cbRepeatRow:not(:first)").filter(function(){return w(this).closest(".cbRepeat").is(e.element)});t.find('.cbTooltip,[data-hascbtooltip="true"]').off("remove removeqtip");t.remove();p.call(this,e);return this},rebind:function(){var e=w(this).data("cbrepeat");if(!e){return this}e.element.cbrepeat("cbrepeat");e.element.cbrepeat(e.options);return this},destroy:function(){var i=w(this).data("cbrepeat");if(!i){return this}if(i.settings.sortable){i.element.sortable("destroy");i.element.removeData("uiSortable");i.element.removeData("ui-sortable")}i.element.find(".cbRepeatRowAdd").filter(function(){return w(this).closest(".cbRepeat").is(i.element)}).off("click.cbrepeat",i.addHandler);i.element.find(".cbRepeatRowRemove").filter(function(){return w(this).closest(".cbRepeat").is(i.element)}).off("click.cbrepeat",i.removeHandler);i.element.off(".cbrepeat");w.each(n,function(e,t){if(t.element==i.element){n.splice(e,1);return false}return true});i.element.removeData("cbrepeat");i.element.triggerHandler("cbrepeat.destroyed",[i]);return this},instances:function(){return n}};function s(e){var t=w(this).data("cbrepeat");if(!t){return false}var i=t.element.find(".cbRepeatRow").filter(function(){return w(this).closest(".cbRepeat").is(t.element)});if(t.settings.max&&i.length>=t.settings.max){return false}var a=i.last();var r=[];a.find("input:checked").each(function(){r.push(w(this))});var n=[];var s=[];var l=[];for(var c=0;c<e;++c){var o=a.find("*");if(t.settings.ignore){o=o.not(t.settings.ignore)}o.each(function(){if(w(this).triggerHandler("cloning")){n.push(w(this))}});var f=a.clone(true);f.insertAfter(a);var d=f.find(".cbRepeat");if(t.settings.ignore){d=d.not(t.settings.ignore)}d.each(function(){var e=this;var t=w(this).find(".cbRepeatRow:not(:first)").filter(function(){return w(this).closest(".cbRepeat").is(w(e))});t.find('.cbTooltip,[data-hascbtooltip="true"]').off("remove removeqtip");t.remove()});o=f.find("*");if(t.settings.ignore){o=o.not(t.settings.ignore)}o.each(function(){if(w(this).is("input,select,textarea")&&!w(this).hasClass("cbRepeatNoReset")&&!w(this).closest(".cbRepeatNoReset").length){var e=w(this).attr("type");var t=w(this).data("cbrepeat-default");if(typeof t!="undefined"){t=w.trim(t)}else{t=null}if(e=="checkbox"||e=="radio"){if(t){if(e=="checkbox"&&t.indexOf("|*|")!=-1){if(t.split("|*|").indexOf(w(this).val())!=-1){w(this).prop("checked",true)}else{w(this).prop("checked",false)}}else{if(w(this).val()==t){w(this).prop("checked",true)}else{w(this).prop("checked",false)}}}else{if(e=="radio"&&w(this).siblings('input[type="radio"]').length+1==2&&w(this).val()==0){w(this).prop("checked",true)}else{w(this).prop("checked",false)}}if(e=="radio"&&w(this).siblings('input[type="radio"]').length+1==2&&w(this).closest(".cbRadioButtonsYesNo").length){if(w(this).val()==0){w(this).next("label").addClass("btn-danger")}else{w(this).next("label").addClass("btn-success")}}if(e=="radio"){w(this).next("label").removeClass("active")}}else{if(t){if(w(this).is("select[multiple]")){t=t.split("|*|")}w(this).val(t)}else{w(this).val("");if(w(this).is("select")){if(!w(this).children('option[value=""]:first').length){w(this).val(w(this).children('option[value!=""]:first').val())}}}}}s.push(w(this))});l.push(f)}p.call(this,t);w.each(r,function(e,t){t.prop("checked",true)});w.each(n,function(e,t){t.triggerHandler("rebind")});w.each(s,function(e,t){t.triggerHandler("cloned")});t.element.triggerHandler("cbrepeat.add",[t,a,e,l,n,s]);return true}function i(e){var t=w(this).data("cbrepeat");if(!t){return false}var i=t.element.find(".cbRepeatRow").filter(function(){return w(this).closest(".cbRepeat").is(t.element)});if(t.settings.min&&i.length<=t.settings.min){return false}if(!e){e=i.last()}e.find('.cbTabs,.cbTooltip,[data-hascbtooltip="true"]').off("remove removeqtip");e.find(".cbRepeat").off("remove.cbrepeat");e.remove();p.call(this,t);t.element.triggerHandler("cbrepeat.remove",[t,e]);return true}function p(R){var i=R.element.find(".cbRepeatRow").filter(function(){return w(this).closest(".cbRepeat").is(R.element)});var e=i.find(".cbRepeatRowRemove").filter(function(){return w(this).closest(".cbRepeatRow").is(i)});var t=e.closest(".cbRepeatRowIncrement").filter(function(){return w(this).closest(".cbRepeatRow").is(i)});if(i.length>R.settings.min){e.removeClass("hidden");if(t.length){t.removeClass("hidden")}if(R.settings.sortable){R.element.sortable("enable")}}else{e.addClass("hidden");if(t.length){t.addClass("hidden")}if(R.settings.sortable){R.element.sortable("disable")}}if(R.settings.max){var a=i.find(".cbRepeatRowAdd").filter(function(){return w(this).closest(".cbRepeatRow").is(i)});var r=null;if(!a.length){a=R.element.find(".cbRepeatRowAdd").filter(function(){return w(this).closest(".cbRepeat").is(R.element)});r=a.closest(".cbRepeatRowIncrement").filter(function(){return w(this).closest(".cbRepeat").is(R.element)})}else{r=a.closest(".cbRepeatRowIncrement").filter(function(){return w(this).closest(".cbRepeatRow").is(i)})}if(i.length>=R.settings.max){a.addClass("hidden");if(r.length){r.addClass("hidden")}}else{a.removeClass("hidden");if(r.length){r.removeClass("hidden")}}}if(!R.settings.sortable||i.length<=1){i.find(".cbRepeatRowSort").filter(function(){return w(this).closest(".cbRepeatRow").is(i)}).addClass("hidden")}else if(i.length>1){i.find(".cbRepeatRowSort").filter(function(){return w(this).closest(".cbRepeatRow").is(i)}).removeClass("hidden")}var _=false;i.each(function(v){var e=w(this).find("*[id],*[for],*[name],*[data-cbrepeat-fallback-id],*[data-cbrepeat-fallback-for],*[data-cbrepeat-fallback-name]").filter(function(){return w(this).closest(".cbRepeatRow").is(i)});if(R.settings.ignore){e=e.not(R.settings.ignore)}var t=w(this).find(".cbRepeatRowIndex").filter(function(){return w(this).closest(".cbRepeatRow").is(i)});if(t.length){t.each(function(){if(w(this).is("input")){if(w(this).is('[type="hidden"]')){w(this).val(v)}else{w(this).val(v+1)}}else{w(this).html(v+1)}})}e.each(function(){if(w(this).attr("id")||w(this).attr("data-cbrepeat-fallback-id")){var e="id";if(!w(this).attr("id")){e="data-cbrepeat-fallback-id"}var t=w(this).attr(e);var i=t.replace(/^(.*__)(\d+)(__\w+)$/g,"$1"+v+"$3");var n=t.replace("cbfr_","").replace("cbfv_","").replace(/__[a-zA-Z0-9]+$/g,"");var s=i.replace("cbfr_","").replace("cbfv_","").replace(/__[a-zA-Z0-9]+$/g,"");if(n!==s){_=true;if(!w(this).data("orgId")){w(this).data("orgId",t)}w(this).attr(e,i);w(this).triggerHandler("modified",[t,i,v]);var a=w(this).closest(".cbRepeatRow").find('*[id*="'+n+'"],*[id*="'+n.replace(/_{2,}/g,"__")+'"],*[data-cbrepeat-fallback-id*="'+n+'"],*[id*="'+n.replace(/_{2,}/g,"__")+'"]');if(R.settings.ignore){a=a.not(R.settings.ignore)}a.each(function(){if(w(this).attr("data-cbrepeat-fallback-id")){var e=w(this).attr("data-cbrepeat-fallback-id");var t=e.replace(n,s).replace(n.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__"));if(e!=t){w(this).attr("data-cbrepeat-fallback-id",t)}}if(w(this).attr("id")){var i=w(this).attr("id");var a=i.replace(n,s).replace(n.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__"));if(i==a){return}if(!w(this).data("orgId")){w(this).data("orgId",i)}w(this).attr("id",a);if(typeof cbHideFields!="undefined"){var r=[];w.each(cbHideFields,function(e,t){if(t[0]==i||t[1]==i){r.push(t)}});w.each(r,function(e,t){var i=[];i[0]=t[0].replace(n,s).replace(n.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__"));i[1]=t[1].replace(n,s).replace(n.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__"));i[2]=t[2];i[3]=t[3];i[4]=[];w.each(t[4],function(e,t){i[4].push(t.replace(n,s).replace(n.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__")))});i[5]=[];w.each(t[5],function(e,t){i[5].push(t.replace(n,s).replace(n.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__")))});var a=false;w.each(cbHideFields,function(e,t){if(t[0]==i[0]&&t[1]==i[1]&&t[2]==i[2]&&t[3]==i[3]){a=true}});if(!a){cbHideFields.push(i)}})}w(this).triggerHandler("modified",[i,a,v])}})}}if(w(this).attr("for")||w(this).attr("data-cbrepeat-fallback-for")){var r="for";if(!w(this).attr("for")){r="data-cbrepeat-fallback-for"}var l=w(this).attr(r);var c=l.replace(/^(.*)(\[\d+\])(\[\w+\])$/g,"$1["+v+"]$3").replace(/^(.*__)(\d+)(__\w+)$/g,"$1"+v+"$3");var o=l.replace(/\[[a-zA-Z0-9]+\]$/g,"").replace(/__[a-zA-Z0-9]+$/g,"");var f=c.replace(/\[[a-zA-Z0-9]+\]$/g,"").replace(/__[a-zA-Z0-9]+$/g,"");if(o!==f){_=true;if(!w(this).data("orgFor")){w(this).data("orgFor",l)}w(this).attr(r,c);w(this).triggerHandler("modified-for",[l,c,v]);var d=w(this).closest(".cbRepeatRow").find('*[for*="'+o+'"],*[data-cbrepeat-fallback-for*="'+o+'"]');if(R.settings.ignore){d=d.not(R.settings.ignore)}d.each(function(){if(w(this).attr("data-cbrepeat-fallback-for")){var e=w(this).attr("data-cbrepeat-fallback-for");var t=e.replace(o,f);if(e!=t){w(this).attr("data-cbrepeat-fallback-for",t)}}if(w(this).attr("for")){var i=w(this).attr("for");if(!w(this).data("orgFor")){w(this).data("orgFor",w(this).attr("for"))}w(this).attr("for",w(this).attr("for").replace(o,f));var a=w(this).attr("for");if(i==a){return}w(this).triggerHandler("modified-for",[i,a,v])}})}}if(w(this).attr("name")||w(this).attr("data-cbrepeat-fallback-name")){var p="name";if(!w(this).attr("name")){p="data-cbrepeat-fallback-name"}var h=w(this).attr(p);var b=h.replace(/^(.*)(\[\d+\])(\[\w+\])$/g,"$1["+v+"]$3").replace(/^(.*__)(\d+)(__\w+)$/g,"$1"+v+"$3");var u=h.replace(/\[[a-zA-Z0-9]+\]$/g,"").replace(/__[a-zA-Z0-9]+$/g,"");var g=b.replace(/\[[a-zA-Z0-9]+\]$/g,"").replace(/__[a-zA-Z0-9]+$/g,"");if(u!==g){_=true;if(!w(this).data("orgName")){w(this).data("orgName",w(this).attr(p))}w(this).attr(p,b);w(this).triggerHandler("modified-name",[h,b,v]);var m=w(this).closest(".cbRepeatRow").find('*[name*="'+u+'"],*[data-cbrepeat-fallback-name*="'+u+'"]');if(R.settings.ignore){m=m.not(R.settings.ignore)}m.each(function(){if(w(this).attr("data-cbrepeat-fallback-name")){var e=w(this).attr("data-cbrepeat-fallback-name");var t=e.replace(u,g);if(e!=t){w(this).attr("data-cbrepeat-fallback-name",t)}}if(w(this).attr("name")){var i=w(this).attr("name");var a=w(this).attr("name").replace(u,g);if(i==a){return}if(!w(this).data("orgName")){w(this).data("orgName",i)}w(this).attr("name",a);w(this).triggerHandler("modified-name",[i,a,v])}})}}})});var n=w(this).find(".cbRepeatCount").filter(function(){return w(this).closest(".cbRepeat").is(R.element)});if(n.length){n.each(function(){if(w(this).is("input")){if(w(this).is('[type="hidden"]')){w(this).val(i.length)}else{w(this).val(i.length)}}else{w(this).html(i.length)}})}if(_){if(i.length==R.settings.min){R.element.addClass("cbRepeatMin")}else if(i.length==R.settings.max){R.element.addClass("cbRepeatMax")}else{R.element.removeClass("cbRepeatMin cbRepeatMax")}if(typeof cbHideFields!="undefined"){var s=[];w.each(cbHideFields,function(e,t){if(!w("#"+t[0]).length){s.push(t)}});w.each(s,function(e,t){cbHideFields.splice(cbHideFields.indexOf(t),1)})}if(typeof cbInitFields!="undefined"){cbInitFields()}R.element.triggerHandler("cbrepeat.updated",[R])}}w.fn.cbrepeat=function(e){if(t[e]){return t[e].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof e==="object"||!e){return t.init.apply(this,arguments)}return this};w.fn.cbrepeat.defaults={init:true,useData:true,sortable:true,ignore:null,add:true,remove:true,min:1,max:0,limit:25}})(jQuery);